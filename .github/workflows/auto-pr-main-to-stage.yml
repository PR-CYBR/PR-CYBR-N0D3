name: Auto PR from main to stage
on:
  push:
    branches: [main]
  workflow_dispatch:
permissions:
  contents: write
  pull-requests: write
jobs:
  create-pull-request:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect if branches differ
        id: diff
        run: |
          if git fetch origin stage:refs/remotes/origin/stage 2>/dev/null; then
            AHEAD=$(git rev-list --left-right --count origin/stage...origin/main 2>/dev/null | cut -f2 || echo "0")
          else
            echo "Stage branch does not exist yet. Will create PR to initialize it."
            AHEAD=1
          fi
          echo "ahead=$AHEAD" >> $GITHUB_OUTPUT

      - name: Create or reuse PR main → stage
        if: steps.diff.outputs.ahead != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo
            const head = 'main'
            const base = 'stage'

            // Use Octokit v20+ style
            const {data: prs} = await github.rest.pulls.list({
              owner, repo, state: 'open', head: `${owner}:${head}`, base
            })

            if (prs.length > 0) {
              core.info(`Open PR already exists: #${prs[0].number}`)
            } else {
              const {data: pr} = await github.rest.pulls.create({
                owner, repo, head, base,
                title: 'chore: sync main → stage',
                body: 'Automated PR from main to stage'
              })
              core.info(`Created PR #${pr.number}`)
            }

      - name: No changes to sync
        if: steps.diff.outputs.ahead == '0'
        run: echo "Branches are already in sync. Nothing to do."
